#!/bin/bash

set -e

RUN_DIR=/var/vcap/sys/run/splunk-nozzle
LOG_DIR=/var/vcap/sys/log/splunk-nozzle
DATA_DIR=/var/vcap/data/splunk-nozzle
PIDFILE=${RUN_DIR}/pid

PACKAGE_DIR=/var/vcap/packages/splunk-nozzle

source /var/vcap/packages/common/pid_utils.sh

case $1 in

  start)
    mkdir -p ${DATA_DIR} ${RUN_DIR} ${LOG_DIR}
    chown -R vcap:vcap ${RUN_DIR} ${LOG_DIR} ${DATA_DIR} ${PACKAGE_DIR}/

    pid_guard $PIDFILE "client-registrar"
    echo $$ > "${PIDFILE}"

    export SKIP_SSL_VALIDATION=<%= p('cf_splunk.skip_ssl_validation', false) %>
    export JOB_NAME=<%= spec.name %>
    export JOB_INDEX=<%= spec.index %>
    export JOB_HOST=<%= spec.address %>

    export UAA_ENDPOINT=<%= p('cf_splunk.uaa_endpoint') %>
    export FIREHOSE_UAA_USER=<%= p('cf_splunk.firehose_uaa_username') %>
    export FIREHOSE_UAA_SECRET=<%= p('cf_splunk.firehose_uaa_secret') %>

    <% if properties.cf_splunk.add_app_info %>
    export ADD_APP_INFO=true
    export API_ENDPOINT=<%= p('cf_splunk.api_endoint') %>
    export API_USER=<%= p('cf_splunk.api_user') %>
    export API_PASSWORD=<%= p('cf_splunk.api_password') %>
    export BOLTDB_PATH=${DATA_DIR}/cache.db
    <% end %>

    export DOPPLER_ENDPOINT=<%= p('cf_splunk.doppler_endpoint') %>
    export EVENTS=<%= p('cf_splunk.events', 'ValueMetric,CounterEvent,Error,ContainerMetric') %>
    export FIREHOSE_SUBSCRIPTION_ID=<%= p('cf_splunk.firehose_subscription_id', 'splunk-firehose-subscription') %>

    export SPLUNK_TOKEN=<%= p('cf_splunk.splunk_token') %>
    export SPLUNK_HOST=http://localhost:8088
    export SPLUNK_INDEX=<%= p('cf_splunk.splunk_index') %>

    exec chpst -u vcap:vcap ${PACKAGE_DIR}/bin/splunk-firehose-nozzle \
      >>  $LOG_DIR/splunk-nozzle.stdout.log \
      2>> $LOG_DIR/splunk-nozzle.stderr.log

    ;;

  stop)
    kill_and_wait "${PIDFILE}"

    ;;

  *)
    echo "Usage: ctl.sh {start|stop}" ;;

esac
